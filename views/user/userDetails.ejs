<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/fonts.css">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/fonts.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- jQuery (included once) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" integrity="sha512-hvNR0F/e2J7zPPfLC9auFe3/SE0yG4aJCOd/qxew74NN7eyiSKjr7xJJMu1Jy2wf7FXITpWS1E/RY8yzuXN7VA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js" integrity="sha512-9KkIqdfN7ipEW6B6k+Aq20PV31bjODg4AA52W+tYtAE0jE0kMx49bjJ3FgvS56wzmyfMUHbQ4Km2b7l9+Y/+Eg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        #imageDiv {
            min-width: 150px;
            min-height: 150px;
            position: relative;
            transition: filter 0.3s ease;
        }
        
        #imageDiv:hover {
            filter: sepia(50%);
        }
        
        #currentImage{
            min-width: 150px;
            min-height: 150px;
            max-width:200px;
            border-radius: 50%;
        }
        
        #imageEdit{
            position: absolute;
            top:50%;
            left:50%;
            transform: translate(-50%, -50%);
            opacity: 1%;
            transition: opacity 0.3s ease;
        }

        #imageDiv:hover #imageEdit{
            visibility: visible;
            opacity: 100%;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-sm navbar-expand-lg border-bottom ">
        <div class="container-fluid bg-white" style="z-index: 1;">
            <a class="navbar-brand d-flex align-items-center ms-5 " href="#">
                    <path
                        d="M34 1H4L1 5.63571M34 1L37 5.63571L25 24.1786M34 1L22 19.5429M1 5.63571H25L19 14.9071L16 10.2714M1 5.63571L16 28.8143L4 47.3571M1 5.63571L22 38.0857H16H28L10 10.2714M16 10.2714L28 28.8143M16 10.2714L37 42.7214M22 10.2714H10M10 10.2714L22 28.8143M37 42.7214L34 47.3571H4M37 42.7214H13L19 33.45M4 47.3571L1 42.7214L13 24.1786"
                        stroke="black" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <h1 class="m-2 text-dark koulen">SAVAGE</h1>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/home">Home</a>
                    </li>
                    <li class="nav-item dropdown">
                        <button class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-fill"> </i>Account
                        </button>
                        <ul class="dropdown-menu dropdown-menu">
                            <li class="dropdown-item active bg-dark">
                                <a class="nav-link text-white" href="/user/profile/<%=userData._id%>">
                                    <i class="bi bi-person-fill"> </i> User Profile
                                </a>
                            </li>
                            <li class="dropdown-item">
                                <a class="nav-link" href="/user/password/<%=userData._id%>">
                                    <i class="bi bi-key-fill"> </i> Change Password
                                </a>
                            </li>
                            <li class="dropdown-item">
                                <a class="nav-link" href="/user/address/<%=userData._id%>">
                                    <i class="bi bi-person-vcard-fill"> </i> Address
                                </a>
                            </li>
                            <li class="dropdown-item">
                                <a class="nav-link" href="/user/orders/<%=userData._id%>">
                                    <i class="bi bi-box-seam-fill"> </i> Orders
                                </a>
                            </li>
                            <!-- <li class="dropdown-item ">
                                <a class="nav-link" href="/user/wallet/">
                                    <i class="bi bi-wallet2"> </i> SAVAGE-Wallet
                                </a>
                            </li> -->
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger fw-bold" href="/user/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container mt-5 d-flex justify-content-center">
        <div class="col-lg-6">
            <!-- <div class="d-flex justify-content-center" id="PODiv">
                <div class="d-flex border rounded-pill" id="imageDiv">

                    
                    <button class="w-100 h-100 border rounded-pill btn btn-lg btn-transparent" id="imageEdit" data-bs-target="#cropModal" data-bs-toggle="modal">
                        <i class="bi bi-pencil-fill h2 text-white"></i></button>
                </div>
            </div> -->

            <div class="m-4 text-center mtext-103 p-3 border-1 border-black border">
                <span class="">
                    <%= userData.email %>
                </span>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <!-- <div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="d-flex justify-content-between m-3">
                    <h1 class="modal-title fs-5" id="cropModalLabel">Select & crop image</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="cropModal">
                    <div class="image-container" style="height: 300px;">
                            <canvas id="cropperCanvas" style="max-width: 400px;"></canvas>
                    </div>
                    <div id="newImage">

                    </div>
                </div>
                
                <div class="modal-footer">
                    <div class="d-flex">
                        <input type="file" accept="image/*" class="form-control" id="inputImage">
                        <button class="btn btn-dark" id="saveButton">save</button>
                    </div>
                </div>
            </div>
        </div>
    </div> -->


<!-- JavaScript to initialize Cropper -->
<!-- <script>
    $(document).ready(function () {
        const canvas = document.getElementById('cropperCanvas');
        const ctx = canvas.getContext('2d');
        let cropper; 

        $('#inputImage').on('change', function (e) {
            const input = e.target;
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0, img.width, img.height);

                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(canvas, {
                            aspectRatio: 1,
                            viewMode: 1,
                            responsive: true,
                            zoomable: false,
                            crop: function (event) {

                                console.log(event.detail);
                            },
                        });

                    };

                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        $("button.btn-close").on("click",()=>{
            $("input#inputImage").val("")
        })
        
        $('#saveButton').on('click',async function () {
            obj = cropper.getCroppedCanvas();
            console.log(obj)
            obj.toBlob((blob)=>{
                
                const formData = new FormData();
                formData.append("image",blob,"newImage.png");

                fetch("/updatedp", {
                    method: "POST",
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success){
                            document.getElementById("currentImage").src = "/users/" + data.newImageUrl;
                            $("#cropModal").modal("hide")
                            console.log(data.message);
                        }
                    })
                    .catch(error => {
                        console.log(error.message)
                    });

            })
        });
    })
</script> -->



    <div class="container d-flex justify-content-center">
        <div class="col-lg-4">
            <form id="userForm" onsubmit="return profileUpdate('<%= userData._id %>')">

                <div class="form-group m-4">
                    <label for="name">Name <small class="ms-2 text-danger" id="N"></small></label>
                    <input  value="<%= userData.username %>" type="text" disabled class="form-control" id="name" name="name" maxlength="16">
                </div>

                <div class="form-group m-4">
                    <label for="phone">Mobile <small class="ms-2 text-danger" id="P"></small></label>
                    <input value="<%= userData.phone %>" type="number" disabled class="form-control" id="phone"
                        name="phone">
                </div>

                <div class="text-center" id="edit-container">
                    <button type="button" id="editButton" class="btn btn-dark my-2 btn-block"><i
                        class="bi bi-pencil-square"></i>Edit</button>
                        <div id="submit-container" class="d-none">
                            <button type="submit" id="submitButton" class="btn btn-dark my-2 btn-block">Submit</button>
                            <button type="button" id="cancelButton" class="btn btn-dark my-2 btn-block">Cancel</button>
                        </div>
                </div>
            </form>
        </div>
    </div>



    <script>
        // selecting input fields and buttons for actions and events
        const editButton = document.getElementById("editButton");
        const nameInput = document.getElementById("name");
        const phoneInput = document.getElementById("phone");
        const container = document.getElementById("edit-container");
        const submitContainer = document.getElementById("submit-container");
        const cancelButton = document.getElementById("cancelButton");
        // values
        let name = document.getElementById("name").value;
        let phone = document.getElementById("phone").value;

        // edit button toggle
        editButton.addEventListener("click",()=> {
            nameInput.disabled = false;
            phoneInput.disabled = false;
            submitContainer.classList.remove("d-none");
            editButton.classList.add("d-none");
        })
        
        // cancel button toggle
        cancelButton.addEventListener("click",()=> {
            nameInput.value = name;
            phoneInput.value = phone;
            submitContainer.classList.add("d-none");
            editButton.classList.remove("d-none");
            nameInput.disabled = true;
            phoneInput.disabled = true;
            document.getElementById("N").textContent = "";
            document.getElementById("P").textContent = "";
        })
        function profileUpdate(user){
            console.log(user);
            const updateName = document.getElementById("name").value
            const updatedPhone = document.getElementById("phone").value
            const nameError = document.getElementById("N");
            const phoneError = document.getElementById("P");
            const phoneRegexPattern = /^(?!.*(\d)\1{9})(?!.*(\d)\2{3})\d{10}$/;
            const userNamePattern = /^[a-zA-Z\s]{4,16}$/;


            // clearing all error messages before checking the conditions
            nameError.textContent = "";
            phoneError.textContent = "";
            phoneError.textContent = "";

            
            if(name.trim()===updateName.trim() && phone.trim()===updatedPhone.trim()){
                Toastify({
                    text: "Make any changes to update.",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "red",
                }).showToast();
                return false;
            }
            if(updateName.trim()===""){
                nameError.textContent = "name cannot be empty";
                return false;
            }
            if(updatedPhone.trim()===""){
                phoneError.textContent = "mobile number cannot be empty";
                return false;
            }
            if(!phoneRegexPattern.test(updatedPhone)){
                phoneError.textContent = "invalid phone number ";
                return false;
            }
            if(!userNamePattern.test(updateName)){
                nameError.textContent = "enter a min character of 4 with alphabet";
                return false;
            }



            $.ajax({
                url : "/user/profile",
                type : 'PUT',
                data : JSON.stringify({
                    userId : user,
                    name : updateName,
                    phone : updatedPhone,
                }),
                contentType : "application/json",
                success : function (response){
                    if(response.success){
                        nameInput.value = updateName;
                        phoneInput.value = updatedPhone;
                        Toastify({
                            text: "Profile updated.",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "green",
                        }).showToast();
                    submitContainer.classList.add("d-none");
                    editButton.classList.remove("d-none");
                    nameInput.disabled = true;
                    phoneInput.disabled = true;
                    name = updateName;
                    phone = updatedPhone;
                    }else{
                        Toastify({
                            text: "Username already exists.",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "red",
                        }).showToast();
                    }
                },error : function(error){
                    Toastify({
                            text: "An error occured while updating profile.",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "green",
                        }).showToast();
                }
            })

            return false;
        }
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
        </script>

        <!-- toastify -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

</body>

</html>